# 角色过滤修复说明

## 问题现象

日志显示：
```
🎬 生成首帧: shot=scene_001_shot_004, chars=6, scene=True
```

虽然代码已修复，但分镜仍然关联了6个角色。

## 根本原因

### 数据已固化

**分镜设计是一次性操作**。当分镜被生成时，`shot.characters` 字段就已经被填充：

```python
# shot_design_service.py 在生成分镜时设置
shot = Shot(
    ...
    characters=[...]  # ← 这里在分镜生成时就确定了
)
```

**修复前的行为**：
- 分镜1 关联 场景的所有6个角色
- 分镜2 关联 场景的所有6个角色
- ...

**修复后的行为**：
- 根据 `character_ids` 只关联实际出场的角色

### 关键问题

已经生成的分镜，其 `characters` 字段**不会自动更新**！

```
已有项目的数据流：
┌─────────────────┐
│  已有分镜数据    │  ← characters 已包含6个角色
│  (已保存到JSON) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  首帧生成时     │  ← 读取 shot.characters，得到6个角色
│  过滤逻辑正确   │     （但数据已经是错误的6个）
└─────────────────┘
```

## 解决方案

### 方案1：重新生成分镜（推荐）

**适用于**：项目刚开始，分镜数据不重要

**操作步骤**：
1. 进入"分镜设计"页面
2. 记录现有的分镜描述（如有需要）
3. 删除现有分镜（需要添加删除功能，或手动删除项目）
4. 点击"自动生成分镜"
5. 新的分镜将正确关联角色

### 方案2：手动编辑分镜数据

**适用于**：已有项目，不想重新生成分镜

**操作步骤**：
1. 找到项目文件：`~/animation_projects/{project_id}/project.json`
2. 编辑分镜的 `characters` 字段
3. 只保留实际出场的角色ID

**示例**：
```json
{
  "shots": [
    {
      "shot_id": "scene_001_shot_001",
      "characters": ["char_001", "char_002"]  // ← 只保留实际出场的
    }
  ]
}
```

### 方案3：批量修复脚本（开发中）

可以创建一个脚本来批量修复已有分镜：

```python
# 伪代码
for shot in project.shots:
    # 根据 shot.description 重新分析涉及的角色
    involved_characters = llm_analyze(shot.description, scene.characters)
    shot.characters = involved_characters
    save_shot(shot)
```

---

## 验证修复是否生效

### 新项目的验证方法

1. 创建新项目
2. 解析剧本（提取角色和场景）
3. 生成分镜
4. 查看分镜详情的角色关联

**期望结果**：
```
分镜1（只有主角）：characters = ["char_001"]
分镜2（主角+配角）：characters = ["char_001", "char_002"]
分镜3（空镜）：characters = []
```

### 查看日志确认

首帧生成时的日志：
```
🎬 生成首帧: shot=scene_001_shot_001, chars=1, scene=True  ← 只有1个角色
🎬 生成首帧: shot=scene_001_shot_002, chars=2, scene=True  ← 2个角色
```

---

## 代码修复总结

### 修复的文件

| 文件 | 修复内容 |
|------|----------|
| `shot_design_service.py` | 解析 `character_ids`，过滤有效角色 |
| `default_config.yaml` | 更新提示词，要求返回 `character_ids` |
| `Shots.vue` | 更新占位符说明 |

### 修复后的分镜生成流程

```
1. LLM 生成分镜数据
   ↓
2. 包含 character_ids 字段
   ↓
3. 过滤验证（只保留场景中的角色）
   ↓
4. 创建 Shot 对象（使用过滤后的角色列表）
   ↓
5. 保存分镜
```

---

## 建议

### 对于新项目
- ✅ 修复已生效，无需额外操作

### 对于已有项目
- 如果分镜刚生成，建议**删除后重新生成**
- 如果分镜已经过人工编辑，建议**手动修改数据文件**

### 长期方案
- 添加"重新生成分镜"按钮
- 添加"编辑分镜角色"功能
- 批量修复脚本

---

## FAQ

**Q: 为什么修复代码后，已有分镜的角色没有变化？**  
A: 因为 `shot.characters` 在分镜生成时就已确定，修复只影响新生成的分镜。

**Q: 如何确认修复已生效？**  
A: 创建一个新项目，走完流程后生成分镜，检查分镜的角色数量。

**Q: 是否可以批量修复已有分镜？**  
A: 可以，需要开发批量修复脚本，或手动编辑数据文件。

**Q: 角色数量多会有什么影响？**  
A: 首帧生成时会传入所有角色的参考图，增加API成本和生成时间。
